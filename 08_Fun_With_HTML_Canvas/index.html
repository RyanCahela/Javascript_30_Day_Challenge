<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>HTML5 Canvas</title>
  </head>
  <body>
    <canvas id="draw" width="640" height="480"></canvas>
    <script>
      const canvas = document.getElementById("draw");
      const ctx = canvas.getContext("2d");
      const HEIGHT = canvas.height;
      const WIDTH = canvas.width;
      ctx.textBaseLine = "top";

      let timeOfLastFrame = 0;

      const mousePos = { x: 0, y: 0 };
      const lineStartPos = { x: 0, y: 0 };
      let isMarkerOn = false;
      let lineHue = 1; //between 1 and 360;
      let lineWidth = 1;
      let lineSizeDirection = 1; //1 or -1;

      //detect mousedown on canvas
      canvas.addEventListener("mousedown", (e) => {
        const { x: mousePosX, y: mousePosY } = getCurrentPositionInCanvas(e);
        // if click set marker on
        isMarkerOn = true;
        lineStartPos.x = mousePosX;
        lineStartPos.y = mousePosY;
        lineWidth = 1;
        console.log("isMarkerOn", isMarkerOn);
      });

      //detect mouseup on canvas
      canvas.addEventListener("mouseup", (e) => {
        isMarkerOn = false;
        lineWidth = 1;
        console.log("isMarkerOn", isMarkerOn);
      });
      //if mouseup set marker off

      canvas.addEventListener("mousemove", (e) => {
        const { x: mousePosX, y: mousePosY } = getCurrentPositionInCanvas(e);

        drawMarker(mousePosX, mousePosY);

        //set new line start for next mousemove event
        lineStartPos.x = mousePosX;
        lineStartPos.y = mousePosY;
      });

      canvas.addEventListener("mouseleave", (e) => {
        isMarkerOn = false;
        lineWidth = 1;
      });

      const loop = (totalElapsedTime) => {
        const currentTime = totalElapsedTime / 1000; //convert miliseconds to seconds
        const deltaTime = timeOfLastFrame - currentTime;
        timeOfLastFrame = currentTime;

        requestAnimationFrame(loop);
        //ctx.clearRect(0, 0, WIDTH, HEIGHT);

        displayMousePosition();
      };

      function drawMarker(mousePosX, mousePosY) {
        if (!isMarkerOn) return;
        if (lineWidth >= 100 || lineWidth <= 0) {
          lineSizeDirection = -lineSizeDirection;
        }

        const colorChangeSpeed = 10;
        lineHue += colorChangeSpeed;
        lineWidth += lineSizeDirection;

        console.log("lineWidth", lineWidth);

        ctx.strokeStyle = `hsl(${lineHue}, 100%, 50%)`;
        ctx.lineWidth = lineWidth;
        ctx.lineJoin = "round";
        ctx.lineCap = "round";
        ctx.beginPath();
        ctx.moveTo(lineStartPos.x, lineStartPos.y);
        ctx.lineTo(mousePosX, mousePosY);
        ctx.stroke();
      }

      function displayMousePosition() {
        //display mouse position
        ctx.save();
        ctx.fillStyle = "black";
        ctx.font = "20pt monospace";
        ctx.textAlign = "center";
        ctx.fillText(
          `x:${mousePos.x}, y: ${mousePos.y}`,
          WIDTH - WIDTH / 2,
          HEIGHT - HEIGHT / 2
        );
        ctx.restore();
        //end display mouse position;
      }

      function getCurrentPositionInCanvas(mouseEvent) {
        const { clientX, clientY } = mouseEvent;
        const { left, top } = canvas.getBoundingClientRect();
        return { x: clientX - left, y: clientY - top };
      }

      requestAnimationFrame(loop);
    </script>

    <style>
      html,
      body {
        margin: 0;
        box-sizing: border-box;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      canvas {
        border: 2px solid #212121;
      }
    </style>
  </body>
</html>
